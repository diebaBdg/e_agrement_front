<!-- Header -->
<app-shared-header>
  <div class="header-container">
    <div class="logo-section">
      <div class="logo-icon">‚úì</div>
      <div class="logo-text">
        <h1 class="logo-title">Agr√©ments S√©n√©gal</h1>
        <p class="logo-subtitle">R√©publique du S√©n√©gal</p>
      </div>
    </div>
    <nav class="nav-menu">
      <a routerLink="/" class="nav-link">Accueil</a>
      <a routerLink="/nouvelle-demande" class="nav-link active">Nouvelle Demande</a>
      <a routerLink="/suivre" class="nav-link">Suivre</a>
    </nav>
    <div class="header-actions">
      <a routerLink="/connexion" class="btn-link">Connexion</a>
      <a routerLink="/inscription" class="btn-secondary">S'inscrire</a>
      <a routerLink="/nouvelle-demande" class="btn-primary">Nouvelle Demande</a>
    </div>
  </div>
</app-shared-header>

<!-- Main Content -->
<main class="main-content">
  <div class="container">
    <!-- Page Title -->
    <div class="page-title-section">
      <h1 class="page-title">Nouvelle Demande d'Agr√©ment</h1>
      <p class="page-subtitle">
        Veuillez remplir tous les champs requis et t√©l√©charger les documents n√©cessaires
      </p>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="progress"></div>
      </div>
      <p class="progress-text">√âtape {{ currentStep }} sur {{ totalSteps }}</p>
    </div>

    <!-- Stepper -->
    <div class="stepper">
      <div 
        class="step-item" 
        [class.active]="currentStep === 1"
        [class.completed]="currentStep > 1"
        (click)="goToStep(1)"
      >
        <div class="step-number">1</div>
        <div class="step-label">Type d'Agr√©ment</div>
      </div>
      <div class="step-connector" [class.completed]="currentStep > 1"></div>
      <div 
        class="step-item" 
        [class.active]="currentStep === 2"
        [class.completed]="currentStep > 2"
        (click)="goToStep(2)"
      >
        <div class="step-number">2</div>
        <div class="step-label">Informations du Demandeur</div>
      </div>
      <div class="step-connector" [class.completed]="currentStep > 2"></div>
      <div 
        class="step-item" 
        [class.active]="currentStep === 3"
        [class.completed]="currentStep > 3"
        (click)="goToStep(3)"
      >
        <div class="step-number">3</div>
        <div class="step-label">Informations de l'√âtablissement</div>
      </div>
      <div class="step-connector" [class.completed]="currentStep > 3"></div>
      <div 
        class="step-item" 
        [class.active]="currentStep === 4"
        [class.completed]="currentStep > 4"
        (click)="goToStep(4)"
      >
        <div class="step-number">4</div>
        <div class="step-label">Documents</div>
      </div>
    </div>

    <!-- Form Card -->
    <div class="form-card">
      <!-- Step 1: Type d'Agr√©ment -->
      <div class="form-step" *ngIf="currentStep === 1">
        <h2 class="section-title">Type d'Agr√©ment</h2>
        
        <div *ngIf="loadingTypes" style="text-align: center; padding: 2rem;">
          <p>Chargement des types d'agr√©ment...</p>
        </div>

        <div class="form-group" *ngIf="!loadingTypes">
          <label class="form-label">
            Type d'agr√©ment demand√© <span class="required">*</span>
          </label>
          <select 
            class="form-select"
            [(ngModel)]="formData.typeAgrementId"
            name="typeAgrement"
            required
          >
            <option value="">S√©lectionnez le type d'agr√©ment</option>
            <option *ngFor="let type of agrementTypes" [value]="type.id">
              {{ type.libelle }}
            </option>
          </select>
          
          <!-- Afficher la description du type s√©lectionn√© -->
          <div *ngIf="formData.typeAgrementId" style="margin-top: 1rem; padding: 1rem; background: #f0fdfa; border-radius: 8px;">
            <p style="margin: 0; color: #0d9488; font-weight: 500;">
              {{ getTypeAgrementLibelle(formData.typeAgrementId) }}
            </p>
          </div>
        </div>
      </div>

      <!-- Step 2: Informations du Demandeur -->
      <div class="form-step" *ngIf="currentStep === 2">
        <h2 class="section-title">Informations du Demandeur</h2>
        
        <div *ngIf="isAuthenticated" style="padding: 1rem; background: #dbeafe; border-radius: 8px; margin-bottom: 1.5rem;">
          <p style="margin: 0; color: #1e40af; font-weight: 500;">
            ‚ÑπÔ∏è Vos informations ont √©t√© pr√©-remplies automatiquement
          </p>
        </div>
        
        <div class="form-group">
          <label class="form-label">
            Nom complet <span class="required">*</span>
          </label>
          <input 
            type="text" 
            class="form-input"
            placeholder="Ex: Amadou Diallo"
            [(ngModel)]="formData.nomCompletDemandeur"
            name="nomComplet"
            [readonly]="isAuthenticated"
            required
          />
        </div>
        <div class="form-group">
          <label class="form-label">
            Email <span class="required">*</span>
          </label>
          <input 
            type="email" 
            class="form-input"
            placeholder="exemple@email.com"
            [(ngModel)]="formData.emailDemandeur"
            name="email"
            [readonly]="isAuthenticated"
            required
          />
        </div>
        <div class="form-group">
          <label class="form-label">
            T√©l√©phone <span class="required">*</span>
            <span *ngIf="loadingUser && isAuthenticated" style="font-size: 0.875rem; color: #6b7280;">
              (Chargement...)
            </span>
          </label>
          <input 
            type="tel" 
            class="form-input"
            placeholder="+221 77 123 4567"
            [(ngModel)]="formData.telephoneDemandeur"
            name="telephone"
            [readonly]="isAuthenticated"
            required
          />
          <div *ngIf="isAuthenticated && !loadingUser && !formData.telephoneDemandeur" style="margin-top: 0.5rem; font-size: 0.875rem; color: #ef4444;">
            <p>‚ö†Ô∏è Aucun t√©l√©phone trouv√© dans votre profil. Veuillez le renseigner.</p>
          </div>
        </div>
      </div>

      <!-- Step 3: Informations de l'√âtablissement -->
      <div class="form-step" *ngIf="currentStep === 3">
        <h2 class="section-title">Informations de l'√âtablissement</h2>
        <div class="form-group">
          <label class="form-label">
            Nom de l'√©tablissement <span class="required">*</span>
          </label>
          <input 
            type="text" 
            class="form-input"
            placeholder="Ex: Clinique Internationale de Dakar"
            [(ngModel)]="formData.nomEtablissement"
            name="nomEtablissement"
            required
          />
        </div>
        <div class="form-group">
          <label class="form-label">
            Adresse compl√®te <span class="required">*</span>
          </label>
          <textarea 
            class="form-textarea"
            placeholder="Ex: Avenue Cheikh Anta Diop, Dakar, S√©n√©gal"
            [(ngModel)]="formData.adresseEtablissement"
            name="adresse"
            rows="4"
            required
          ></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">
            Description de l'activit√© <span class="required">*</span>
          </label>
          <textarea 
            class="form-textarea"
            placeholder="D√©crivez l'activit√© et les services propos√©s..."
            [(ngModel)]="formData.descriptionActivite"
            name="descriptionActivite"
            rows="6"
            required
          ></textarea>
        </div>
      </div>

      <!-- Step 4: Documents Justificatifs -->
      <div class="form-step" *ngIf="currentStep === 4">
        <h2 class="section-title">Documents Justificatifs</h2>
        <div 
          class="upload-zone"
          (dragover)="$event.preventDefault()"
          (drop)="onFileDropped($event)"
          (click)="fileInput.click()"
        >
          <input 
            #fileInput
            type="file" 
            multiple
            accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
            (change)="onFileSelected($event)"
            style="display: none;"
          />
          <div class="upload-icon">‚¨ÜÔ∏è</div>
          <p class="upload-text">Cliquez pour t√©l√©charger ou glissez-d√©posez</p>
          <p class="upload-hint">PDF, Word, ou images (max. 10MB par fichier)</p>
        </div>

        <!-- Selected Files List -->
        <div class="files-list" *ngIf="selectedFiles.length > 0">
          <div class="file-item" *ngFor="let file of selectedFiles; let i = index">
            <div class="file-info">
              <span class="file-icon">üìÑ</span>
              <span class="file-name">{{ file.name }}</span>
              <span class="file-size">({{ (file.size / 1024 / 1024).toFixed(2) }} MB)</span>
            </div>
            <button class="file-remove" (click)="removeFile(i)">‚úó</button>
          </div>
        </div>
      </div>

      <!-- Message d'erreur -->
      <div *ngIf="errorMessage" style="padding: 1rem; background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; margin-top: 1.5rem; color: #dc2626;">
        {{ errorMessage }}
      </div>

      <!-- Navigation Buttons -->
      <div class="form-actions">
        <button 
          class="btn-cancel" 
          (click)="onCancel()"
          *ngIf="currentStep === totalSteps"
        >
          Annuler
        </button>
        <button 
          class="btn-previous" 
          (click)="previousStep()"
          *ngIf="currentStep > 1"
        >
          ‚Üê Pr√©c√©dent
        </button>
        <button 
          class="btn-next" 
          (click)="nextStep()"
          *ngIf="currentStep < totalSteps"
          [disabled]="!isStepValid(currentStep)"
        >
          Suivant ‚Üí
        </button>
        <button 
          class="btn-submit" 
          (click)="onSubmit()"
          *ngIf="currentStep === totalSteps"
          [disabled]="!isStepValid(currentStep) || loading"
        >
          <span *ngIf="!loading">Soumettre la Demande</span>
          <span *ngIf="loading">Soumission en cours...</span>
        </button>
      </div>
    </div>
  </div>
</main>